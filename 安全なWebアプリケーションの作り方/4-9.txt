■メールに関する脆弱性
メール送信に関する脆弱性について記載する。

★メールヘッダインジェクション
メールのヘッダ部分に改行を挿入することで任意のフィールドを追加する攻撃手法である。
メールはヘッダとボディから成り、空行と改行で識別される。
これを悪用し、任意のヘッダ/ボディを挿入することが可能となる。
詳細は後述。

★hiddenパラメータの改ざん
ヘッダインジェクションとは、to/subject等のメールヘッダを外部から指定する場合に発生する。
改行文字を利用して、メールヘッダに任意のヘッダを追加する。
以下の様な問題が発生する可能性がある。
1.件名や送信元、本文が改ざんされる。
2.迷惑メールの送信に悪用される。
3.ウイルスメールの送信に悪用される。

対策として、以下を考える。
1.外部からのパラメータをメールヘッダに含めないようにする。
　→渡されたパラメータをチェックし、ヘッダを含む場合はエラーとする。
2.外部からのパラメータに対し、改行を含まないようにする。
　→渡されたパラメータをチェックし、改行を含む場合はエラーとする。

★攻撃例
前提として、Webアプリケーションが渡されたパラメータをそのまま展開し、メールを生成する脆弱性を持つものとする。
★宛先ヘッダの追加
問い合わせフォームを考える。
textareaで利用者が自由にデータを入力できる環境を想定し、
以下の様なデータを挿入する。
hoge@hoge.com(改行)
Bcc:piyo@piyo.com
このデータを処理するWebアプリケーションの不備により、Bcc:のヘッダが追加される。
これを利用することで、問い合わせフォームを踏み台にして、第三者が迷惑メールを送信することが可能となる。
この場合、Bcc以外にもCc,To等のヘッダを指定可能となる。
★本文の改ざん
メールヘッダインジェクションにより、メール本文を変更できる。
Fromヘッダに空行を挟み、挿入したいメール本文を記載する。
これにより、本来のメール本文の先頭に任意のデータが追加される。
また、multipart/mixedという形式を用いると任意のファイルを添付して
送信する脆弱性が発生してしまう。

★対策とまとめ
メールヘッダインジェクションはヘッダとボディを識別する空行の処理が十分でない場合に発生する。
メールのヘッダ/ボディに対するチェックは独自で実装せず、一般的なライブラリを利用すべきである。
保険的な対策として、利用者から渡されたパラメータのチェックを行い、問題なければ
メール送信用ライブラリを経由し実行するようにする。