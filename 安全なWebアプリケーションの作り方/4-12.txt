■ファイルアップロードに関する脆弱性
利用者がファイルをアップロード/ダウンロードする機能を備えるサーバについて、
脆弱性が発生する場合がある。

■Dos攻撃に対する脆弱性
巨大なファイルをアップロードすることで、Webサーバに対し負荷をかけることができる。
これを防止する方法として、1ファイルあたりの容量を制限することが有効である。
★PHPの場合
PHPの場合、php.iniの設定により、アップロードの容量制限を行うことができる。

★Apacheの場合
httpd.confの設定により、リクエストボディの容量制限を行うことができる。
LimiteRequestBody 102400

■アップロードファイルによるスクリプト実行の脆弱性
利用者がアップロードしたスクリプトを公開ディレクトリに設置する機能を備える
Webアプリケーションを考える。(画像アップローダ等)
アップロードしたファイルの拡張子がphp,jsp等であった場合、Webアプリケーションとして
実行できてしまう可能性がある。
これにより以下のような不具合が生じる。
1.Webサーバ内のデータの不正アクセス/改ざん
2.外部へのメール中継
3.別のサーバへの攻撃の踏み台

このため、アップロードしたファイルに対しては拡張子をチェックすると共に、
公開ディレクトリに配置せずに、スクリプト経由でアクセスさせる方法が望ましい。
以下の様な例を考える。
/var/uploadに対しアップロードされたファイルを設置する。
公開ディレクトリは/var/wwwであり、内部のスクリプトからしか/var/uploadはアクセスできない仕様である。
また、アップロードされる拡張子をチェックし、内部のスクリプトでチェックすることが重要である。

■スクリプトのアップロードによるデータの盗難
以下の様なPHPをアップロードすることで、Webサーバで実行される不具合が生じる。
★hoge.php
<pre>
<?php
	system('/bin/cat /etc/passwd');
?>
</pre>
これらの権限はWebアプリケーションのユーザの持つ権限で動作するため、
過大な権限を付与していた場合に被害が拡大する。

■脆弱性対策
以下の条件双方を満たす場合にアップロードに関連する脆弱性が発生する。
1.アップロードしたデータが公開ディレクトリに設置される場合。
  →アップロードする際に公開ディレクトリでない場所に設置する。
  　以下の様な例を考える
   公開ディレクトリ:/var/www
   アップロード先：/var/upload
  　ダウンロードする際にダウンロードスクリプトを挟み、直接設置場所にアクセスさせないようにする。
2.アップロードしたデータが実行可能なスクリプトであり、利用者が拡張子を指定できる場合。

■ダウンロードによるXSS脆弱性
画像ファイルのアップロード/ダウンロードが可能なサイトを考える。
Webアプリケーションが想定するファイル形式でない場合にXSSの脆弱性が発生する可能性がある。
画像ファイルの中にJavascriptやHtmlのタグを含め、利用者のブラウザが誤認することで発生する。
以下の様な項目を確認することが重要である。(詳細は後述)
1.Content-Typeを確認する。
2.拡張子とマジックバイトが対応していることを確認する。
3.ダウンロードを想定するファイルにはレスポンスヘッダとしてContent-Disposition:attachmentを指定する。

★画像ファイルに偽装したスクリプトの例
以下の様なファイルを考える。
hoge.png
<script>alert('hoge');</script>
IE7以前の古いブラウザではJavascriptが実行される。

★マジックバイトによる判別
マジックバイトとは、ファイルの先頭に置かれたファイルを識別する固定の文字列である。
例として、以下の様な文字列が存在する。
GIF:GIF87a or GIF89a
JPEG:\xFF\xD8\xFF

★判別パターン例
☆Content-Typeとマジックバイトが一致する場合
Content-Typeが示すファイルの種類を優先して採用する。
☆Content-Typeとマジックバイトが一致しない場合
ファイルの中身を確認し採用する。
htmlタグが含まれていた場合はhtmlとする等である。

★アップロード時の対策パターン
ファイルアップロード時のXSS対策として以下を考慮する。
1.許可された拡張子であるか。
2.画像である場合は、マジックバイトも確認する。
  →PHPの場合、getimagesize関数が利用できる。

★ダウンロード時の対策パターン
ファイルダウンロード時のXSS対策として以下を考慮する。
1.Content-Typeを確認する。
2.画像である場合は、マジックバイトも確認する。
  →PHPの場合、getimagesize関数が利用できる。
3.必要に応じてContent-Dispositionをヘッダを設定する。

1.について、対策として公開/非公開ディレクトリのどちらに配置するかにより、対策が異なる。
非公開：Content-Typeを適切に設定する。PDFであれば、application/pdfとする。
2.について、アップロード時に確認すべきだが、何らかの原因で公開されてしまっている場合、
確認が必要である。
3.について、以下の様な設定を行う。
このヘッダを設定することで、ダウンロードを行うだけか、アプリケーションで開くのかを指定できる。
★ダウンロードのみを指定
Content-Dispostion:attachment;filename="hoge.pdf"
Content-Type:application/octet-stream
尚、filenameは保存するときのデフォルト名である。